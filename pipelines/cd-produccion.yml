trigger:
  - Produccion

variables:
  - group: GitHubSecrets

pool:
  name: 'Default'

steps:
# Paso 1: Verificar el agente
- script: echo "Iniciando Deploy a Producci贸n..."
  displayName: 'Verificar Agente'

# Paso 2: Despliegue (personalizable)
# Aqu铆 puedes poner AzureWebApp o cualquier otra acci贸n de despliegue real.
# - task: AzureWebApp@1
#   inputs:
#     azureSubscription: '<NOMBRE-CONEXIN-SERVICIO>'
#     appName: '<NOMBRE-WEBAPP>'
#     package: '$(System.DefaultWorkingDirectory)/**/*.zip'
#   displayName: 'Desplegar a Producci贸n'

# Paso 3: Notificaci贸n de despliegue
- script: echo " Despliegue completado en Producci贸n"
  displayName: 'Finalizaci贸n del Deploy'

# Paso 4: Push autom谩tico desde Azure a GitHub (Producci贸n limpio y seguro)
- script: |
    echo " Configurando Git..."
    git config --global user.email "dvegacajas2@gmail.com"
    git config --global user.name "Diego Vega"

    echo " Clonando solo la rama Produccion desde GitHub..."
    git clone --single-branch --branch Produccion https://$(GITHUB_TOKEN)@github.com/diegovski02/ProyNaVishe_BACK.git repo-tmp
    cd repo-tmp

    echo "Ч Limpiando el contenido viejo en GitHub..."
    git remote remove origin || echo "El remote 'origin' ya no existe"

    echo " Agregando Azure como remoto (si no existe)..."
    git remote add azure $(Build.Repository.Uri) || echo "Remote Azure ya existe"

    echo " Haciendo pull desde Azure (rama Produccion)..."
    git pull azure Produccion --rebase || echo "No se pudo traer cambios desde Azure"

    echo " Copiando el contenido actual de Azure DevOps (ya autenticado)..."
    git add . || echo "No hay cambios para agregar"
    git commit -m "Commit de sincronizaci贸n desde Azure DevOps a GitHub" || echo "No hay cambios para commitear"

    echo " Haciendo push forzado a GitHub (Producci贸n)..."
    git push origin Produccion --force || echo "Hubo un error al hacer el push"

  displayName: "Push forzado desde Azure a GitHub (Producci贸n limpio)"
  condition: and(succeeded(), eq(variables['Build.SourceBranchName'], 'Produccion'))
