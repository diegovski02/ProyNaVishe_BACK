trigger:
  - Produccion

variables:
  - group: GitHubSecrets
  - group: AZURE_TOKEN

pool:
  name: 'Default'

steps:
# Paso 1: Verificar el agente
- script: echo 'Iniciando Deploy a Producci贸n...'
  displayName: 'Verificar Agente'

# Verificaci贸n de las variables de los tokens
- script: |
    echo "Verificando AZURE_TOKEN..."
    echo $(AZURE_TOKEN)  # Esto imprimir谩 el valor del AZURE_TOKEN
  displayName: 'Verificar AZURE_TOKEN'

- script: |
    echo "Verificando GITHUB_TOKEN..."
    echo $(GITHUB_TOKEN)  # Esto imprimir谩 el valor del GITHUB_TOKEN
  displayName: 'Verificar GITHUB_TOKEN'

# Paso 2: Despliegue (personalizable)
# Aqu铆 puedes poner AzureWebApp o cualquier otra acci贸n de despliegue real.
# - task: AzureWebApp@1
#   inputs:
#     azureSubscription: '<NOMBRE-CONEXIN-SERVICIO>'
#     appName: '<NOMBRE-WEBAPP>'
#     package: '$(System.DefaultWorkingDirectory)/**/*.zip'
#   displayName: 'Desplegar a Producci贸n'

# Paso 3: Notificaci贸n de despliegue
- script: echo " Despliegue completado en Producci贸n"
  displayName: 'Finalizaci贸n del Deploy'

# Paso 4: Push autom谩tico desde Azure a GitHub (Producci贸n limpio y seguro)
- script: |
    rem Configuramos los usuarios de git
    git config --global user.email "dvegacajas2@gmail.com"
    git config --global user.name "Diego Vega"

    rem Clonamos solo la rama Producci贸n desde GitHub con el token de autenticaci贸n
    git clone --single-branch --branch Produccion https://$(GITHUB_TOKEN)@github.com/diegovski02/ProyNaVishe_BACK.git repo-tmp
    cd repo-tmp

    rem Eliminamos el remoto Azure si ya existe
    git remote remove azure || echo "Remote Azure no existe"

    rem Agregamos el remoto de Azure con el token de Azure
    git remote add azure https://$(AZURE_TOKEN)@dev.azure.com/diegovega2/ProyNaVishe/_git/ProyNaVishe_BACK.git

    rem Traemos los 煤ltimos cambios de la rama Produccion desde Azure
    git pull azure Produccion --rebase

    rem Resolver conflictos si los hay y hacer commit
    git add README.md
    git rebase --continue
    
    rem Hacemos un commit vac铆o si es necesario
    git commit --allow-empty -m "Actualizando desde Azure a GitHub"

    rem Hacemos el push forzado a GitHub
    git push https://$(GITHUB_TOKEN)@github.com/diegovski02/ProyNaVishe_BACK.git Produccion --force
  displayName: "Push forzado desde Azure a GitHub (Producci贸n limpio)"
  condition: and(succeeded(), eq(variables['Build.SourceBranchName'], 'Produccion'))
